<html>
	<head>
		<style>
			th {
				text-align: left;
			}
			td {
				vertical-align: top;
			}
		</style>
		<script>
			var knownCodes = {};

			function estimatorError(
				mass_ratio_uncharacterized,
				impact_standard_deviation
			) {
				const params = [
					0.16590362, 0.2232487, 0.04409559, -0.01290882, 0.44781467,
					-0.0699337, -0.37201226, 0.1213749, -0.09568282, 0.06472759,
				];
				return (
					params[0] +
					params[1] * mass_ratio_uncharacterized +
					params[2] * impact_standard_deviation +
					params[3] *
						mass_ratio_uncharacterized *
						impact_standard_deviation +
					params[4] *
						mass_ratio_uncharacterized *
						mass_ratio_uncharacterized +
					params[5] *
						impact_standard_deviation *
						impact_standard_deviation +
					params[6] *
						mass_ratio_uncharacterized *
						mass_ratio_uncharacterized *
						mass_ratio_uncharacterized +
					params[7] *
						mass_ratio_uncharacterized *
						mass_ratio_uncharacterized *
						impact_standard_deviation +
					params[8] *
						mass_ratio_uncharacterized *
						impact_standard_deviation *
						impact_standard_deviation +
					params[9] *
						impact_standard_deviation *
						impact_standard_deviation *
						impact_standard_deviation
				);
			}

			function cmp(a, b) {
				if (a > b) {
					return 1;
				} else if (b > a) {
					return -1;
				}
				return 0;
			}

			function sortedKeys(m, { increasing = true } = {}) {
				if (increasing) {
					return Object.keys(m).sort((a, b) => {
						return cmp(m[a], m[b]);
					});
				} else {
					return Object.keys(m).sort((b, a) => {
						return cmp(m[a], m[b]);
					});
				}
			}

			function jsonReq(method, url, { body = null } = {}) {
				return new Promise((res, rej) => {
					const req = new XMLHttpRequest();
					req.addEventListener("load", () => {
						res(JSON.parse(req.responseText));
					});
					req.open(method, url);
					req.send(body);
				});
			}

			function loadPage(num) {
				document.getElementById("results").innerHTML =
					"<h1>Loading...</h1>";
				jsonReq(
					"GET",
					"https://world.openfoodfacts.org/misc/ecoscore-extended-data-version-4&no_cache=1&json=1&page=" +
						num
				).then((js) => {
					var listIndex = 0;
					const count = Number.parseInt(js["count"]);
					const page = Number.parseInt(js["page"]);
					const skip = Number.parseInt(js["skip"]);
					document.getElementById("results").innerHTML = `
			<table style="width: 100%;">
			<caption>
			Page ${page}
			</caption>
			<thead>
			<tr>
			<th>Product name</th>
			<th>Barcode</th>
			<th>CIQUAL code</th>
			<th>AgriBalyse proxy impact</th>
			<th>Estimated impact</th>
			<th>Estimated/AgriBalyse impact</th>
			</tr>
			</thead>
			${js["products"]
				.map((prod) => {
					const agribalyse =
						prod["ecoscore_data"]["agribalyse"] || {};
					const estimator = prod["ecoscore_extended_data"] || {};
					const res = `
			<tr>
			<td>
			  <button id="button${listIndex}">${
						prod["product_name"] == ""
							? "[unknown]"
							: prod["product_name"]
					}</button>
			</td>
			<td>${prod["_id"]}</td>
			<td style="background-color: ${
				knownCodes[agribalyse["code"]] ? "green" : "red"
			}">${agribalyse["code"]}</td>
			<td>${agribalyse["ef_agriculture"]}</td>
			<td>${
				estimator["impact"]
					? estimator["impact"]["likeliest_impacts"][
							"EF_single_score"
					  ]
					: estimator["error"]
			}</td>
			<td>${
				estimator["impact"]
					? (10 *
							estimator["impact"]["likeliest_impacts"][
								"EF_single_score"
							]) /
					  agribalyse["ef_agriculture"]
					: ""
			}</td>
			</tr>
			<tr id="expander${listIndex}" style="display: none;">
			<td colspan="6" id="content${listIndex}" style="padding: 1em;">
			</td>
			</tr>
				`;
					listIndex++;
					return res;
				})
				.join("")}
			<tfoot>
			<tr>
			<th>${
				page > 1
					? `<button onClick="loadPage(${page - 1})">&lt;</button>`
					: ""
			}</th>
			<th colspan="4"></th>
			<th>${
				skip < count
					? `<button onClick="loadPage(${page + 1})">&gt;</button>`
					: ""
			}</th>
			</tr>
			</tfoot>
			</table>
			`;
					for (let idx = 0; idx < listIndex; idx++) {
						document
							.getElementById(`button${idx}`)
							.addEventListener("click", (ev) => {
								const expander = document.getElementById(
									`expander${idx}`
								);
								if (expander.style.display == "none") {
									expander.style.removeProperty("display");
								} else {
									expander.style.display = "none";
								}
								if (expander.style.display != "none") {
									const content = document.getElementById(
										`content${idx}`
									);
									content.innerText = "Loading...";
									const prod = js["products"][idx];
									const req = {};
									const agribalyse =
										prod["ecoscore_data"]["agribalyse"];
									if (agribalyse && agribalyse["code"]) {
										req["CIQUALCode"] = agribalyse["code"];
									}
									const impact =
										prod["ecoscore_extended_data"][
											"impact"
										];
									if (impact && impact["likeliest_recipe"]) {
										req["Ingredients"] = Object.keys(
											impact["likeliest_recipe"]
										).map((id) => {
											return id.replaceAll("_", "-");
										});
									}
									jsonReq(
										"POST",
										new URL(
											"/metadata",
											window.location.href
										),
										{
											body: JSON.stringify(req),
										}
									).then((js) => {
										content.innerHTML = `
										${
											impact
												? `
			<dl>
			<dt>Mass ratio uncharacterized ingredients</td>
			<dd>${impact["mass_ratio_uncharacterized"]}</dd>
			<dt>Estimated impact standard deviation<dt>
			<dd>${impact["ef_single_score_log_stddev"]}</dd>
			<dt>95% confidence 95th percentile error of estimation</dt>
			<dd>${estimatorError(
				impact["mass_ratio_uncharacterized"],
				impact["ef_single_score_log_stddev"]
			)}</dd>
												</dl>`
												: ""
										}
			<table style="display: inline; margin: 1em; width: 40%;">
		    <caption>AgriBalyse data for "${js["ProductName"]}"</caption>
			<tr>
			<th>Ingredient</th>
			<th>Percent</th>
			<th>Impact per kg</th>
			<th>Impact * percent</th>
			</tr>
			${
				js["Ingredients"]
					? `
				${js["Ingredients"]
					.map((ingred) => {
						const id = Object.keys(ingred)[0];
						return `<tr><td>${id}</td><td>${(
							ingred[id] || 0
						).toFixed(2)}</td><td>${(
							js["ImpactByIngredient"][id] || 0
						).toFixed(4)}</td><td>${(
							(ingred[id] || 0) *
							(js["ImpactByIngredient"][id] || 0)
						).toFixed(4)}</td></tr>`;
					})
					.join("")}
			`
					: `<tr><td colspan="4">Unknown</td></tr>`
			}
			</table>
			<table style="display: inline; margin: 1em; width: 40%;">
			<caption>Estimator data for "${prod["ingredients_text"]}"</caption>
			<tr>
			<th>Ingredient</th>
			<th>Percent</th>
			<th>Impact per kg</th>
			<th>Impact * percent</th>
			</tr>
			${
				impact && impact["likeliest_recipe"]
					? `
				${sortedKeys(impact["likeliest_recipe"], { increasing: false })
					.map((id) => {
						canonicalizedID = id.replaceAll("_", "-");
						return `<tr><td>${id}</td><td>${(
							impact["likeliest_recipe"][id] || 0
						).toFixed(2)}</td><td>${(
							js["ImpactByIngredient"][canonicalizedID] || 0
						).toFixed(4)}</td><td>${(
							(impact["likeliest_recipe"][id] || 0) *
							(js["ImpactByIngredient"][canonicalizedID] || 0)
						).toFixed(4)}</td></tr>`;
					})
					.join("")}
			`
					: `<tr><td colspan="3">Unknown</td></tr>`
			}
			</table>
							 `;
									});
								}
							});
					}
				});
			}
		</script>
	</head>
	<body>
		<div id="results">
			<h1>Loading...</h1>
		</div>
		<script>
			jsonReq("GET", new URL("/codes", window.location.href)).then(
				(js) => {
					knownCodes = js;
					loadPage(1);
				}
			);
		</script>
	</body>
</html>
